<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOTING KETUA PMR 2025/2026</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQtlCxwhIXyKxuW5FRyRqOElCz-2_EPjs",
            authDomain: "redcross-76c90.firebaseapp.com",
            projectId: "redcross-76c90",
            storageBucket: "redcross-76c90.firebasestorage.app",
            messagingSenderId: "720435310423",
            appId: "1:720435310423:web:058f8f14743135da62d812",
            measurementId: "G-1N1LDV3R95"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // PMR Voting System JavaScript with Firebase Authentication and Vote Tracking
        document.addEventListener('DOMContentLoaded', function() {
            const candidatesContainer = document.getElementById('candidatesContainer');
            const voteBtn = document.getElementById('voteBtn');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            const authSection = document.getElementById('authSection');
            const votingSection = document.getElementById('votingSection');
            const userInfo = document.getElementById('userInfo');

            // Sample candidate data
            const candidates = [
                {
                    id: 'rangga',
                    name: 'Muhammad Rangga',
                    position: 'Calon Ketua PMR',
                    vision: 'Membangun PMR yang lebih aktif dalam pelayanan kesehatan masyarakat dan mengembangkan program-program inovatif untuk meningkatkan kesadaran kesehatan di lingkungan sekolah.',
                    image: 'https://via.placeholder.com/300x200/667eea/ffffff?text=Rangga'
                },
                {
                    id: 'ghazi',
                    name: 'Ghazi',
                    position: 'Calon Ketua PMR',
                    vision: 'Menjadikan PMR organisasi yang layak, terstruktur, dan menjadi teladan dalam bidang kesehatan.',
                    mission: [
                        'Membuat prosedur yang jelas untuk siswa yang sakit',
                        'Memperbaiki komunikasi diantara para anggota, agar dapat bekerja dengan baik',
                        'Memperlayak fasilitas UKS',
                        'Menjadikan anggota PMR paham tentang kesehatan',
                        'Dapat membawa pengaruh baik tentang Kesehatan untuk seluruh warga sekolah'
                    ],
                    image: 'https://via.placeholder.com/300x200/764ba2/ffffff?text=Ghazi'
                }
            ];

            let selectedCandidate = null;
            let currentUser = null;
            let hasVoted = false;

            // Load candidates
            function loadCandidates() {
                candidatesContainer.innerHTML = '';

                candidates.forEach(candidate => {
                    const candidateCard = document.createElement('div');
                    candidateCard.className = 'candidate-card';
                    candidateCard.dataset.id = candidate.id;

                    candidateCard.innerHTML = `
                        <img src="${candidate.image}" alt="${candidate.name}" class="candidate-image">
                        <div class="candidate-name">${candidate.name}</div>
                        <div class="candidate-position">${candidate.position}</div>
                        <div class="candidate-vision">${candidate.vision}</div>
                    `;

                    candidateCard.addEventListener('click', () => selectCandidate(candidate.id));
                    candidatesContainer.appendChild(candidateCard);
                });
            }

            // Select candidate
            function selectCandidate(candidateId) {
                if (hasVoted) {
                    alert('You have already voted!');
                    return;
                }

                // Remove previous selection
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Add selection to clicked card
                const selectedCard = document.querySelector(`[data-id="${candidateId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    selectedCandidate = candidateId;
                    voteBtn.disabled = false;
                }
            }

            // Check if user has already voted
            async function checkUserVoteStatus(userId) {
                try {
                    const voteDoc = await getDoc(doc(db, 'votes', userId));
                    if (voteDoc.exists()) {
                        hasVoted = true;
                        const voteData = voteDoc.data();
                        showAlreadyVoted(voteData);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking vote status:', error);
                    return false;
                }
            }

            // Show already voted message
            function showAlreadyVoted(voteData) {
                authSection.style.display = 'none';
                votingSection.style.display = 'block';

                const candidate = candidates.find(c => c.id === voteData.candidateId);
                userInfo.innerHTML = `
                    <div class="user-profile">
                        <img src="${currentUser.photoURL || 'https://via.placeholder.com/40x40/667eea/ffffff?text=' + currentUser.displayName.charAt(0)}" alt="Profile" class="user-avatar">
                        <div class="user-details">
                            <div class="user-name">${currentUser.displayName}</div>
                            <div class="user-email">${currentUser.email}</div>
                        </div>
                    </div>
                    <div class="vote-status">
                        <h3>You have already voted!</h3>
                        <p>You voted for: <strong>${candidate.name}</strong></p>
                        <p>Voted on: ${new Date(voteData.timestamp.toDate()).toLocaleString()}</p>
                    </div>
                `;

                // Disable voting interface
                voteBtn.style.display = 'none';
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.style.opacity = '0.6';
                    card.style.pointerEvents = 'none';
                });
            }

            // Handle voting
            async function handleVote() {
                if (!selectedCandidate) {
                    alert('Please select a candidate first!');
                    return;
                }

                if (hasVoted) {
                    alert('You have already voted!');
                    return;
                }

                const candidate = candidates.find(c => c.id === selectedCandidate);
                const confirmVote = confirm(`Are you sure you want to vote for ${candidate.name}?`);

                if (confirmVote) {
                    try {
                        // Record vote in Firestore
                        await setDoc(doc(db, 'votes', currentUser.uid), {
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            userName: currentUser.displayName,
                            candidateId: selectedCandidate,
                            candidateName: candidate.name,
                            timestamp: new Date()
                        });

                        // Update local state
                        hasVoted = true;

                        // Show success message
                        voteBtn.textContent = 'Voting...';
                        voteBtn.disabled = true;

                        setTimeout(() => {
                            alert(`Thank you for voting!\nYou voted for: ${candidate.name}`);
                            voteBtn.textContent = 'Vote Submitted âœ“';
                            voteBtn.style.background = '#4caf50';

                            // Update UI to show voted state
                            setTimeout(() => {
                                showAlreadyVoted({
                                    candidateId: selectedCandidate,
                                    candidateName: candidate.name,
                                    timestamp: new Date()
                                });
                            }, 500);
                        }, 1000);

                    } catch (error) {
                        console.error('Error recording vote:', error);
                        alert('Error recording your vote. Please try again.');
                    }
                }
            }

            // Google Sign In Function
            async function signInWithGoogle() {
                try {
                    googleSignInBtn.textContent = 'Signing in...';
                    googleSignInBtn.disabled = true;

                    const result = await signInWithPopup(auth, provider);
                    currentUser = result.user;
                    console.log('User signed in:', currentUser);
                } catch (error) {
                    console.error('Error signing in:', error);
                    alert('Error signing in: ' + error.message);
                } finally {
                    googleSignInBtn.textContent = 'Sign in with Google';
                    googleSignInBtn.disabled = false;
                }
            }

            // Sign Out Function
            async function signOutUser() {
                try {
                    await signOut(auth);
                    currentUser = null;
                    selectedCandidate = null;
                    hasVoted = false;
                    document.querySelectorAll('.candidate-card').forEach(card => {
                        card.classList.remove('selected');
                        card.style.opacity = '';
                        card.style.pointerEvents = '';
                    });
                    voteBtn.textContent = 'Start Voting';
                    voteBtn.disabled = false;
                    voteBtn.style.background = '';
                    voteBtn.style.display = '';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out: ' + error.message);
                }
            }

            // Update UI based on authentication state
            async function updateUI(user) {
                if (user) {
                    // User is signed in
                    authSection.style.display = 'none';
                    votingSection.style.display = 'block';

                    // Check if user has already voted
                    const alreadyVoted = await checkUserVoteStatus(user.uid);

                    if (!alreadyVoted) {
                        userInfo.innerHTML = `
                            <div class="user-profile">
                                <img src="${user.photoURL || 'https://via.placeholder.com/40x40/667eea/ffffff?text=' + user.displayName.charAt(0)}" alt="Profile" class="user-avatar">
                                <div class="user-details">
                                    <div class="user-name">${user.displayName}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // User is signed out
                    authSection.style.display = 'block';
                    votingSection.style.display = 'none';
                    userInfo.innerHTML = '';
                    hasVoted = false;
                }
            }

            // Authentication state observer
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateUI(user);
            });

            // Event Listeners
            googleSignInBtn.addEventListener('click', signInWithGoogle);
            signOutBtn.addEventListener('click', signOutUser);

            // Initialize
            loadCandidates();
            voteBtn.addEventListener('click', handleVote);

            // Add some interactive effects
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected') && !hasVoted) {
                        this.style.transform = 'translateY(-5px)';
                        this.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.1)';
                    }
                });

                card.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected') && !hasVoted) {
                        this.style.transform = '';
                        this.style.boxShadow = '';
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div id="app">
        <header>
            <h1>VOTING</h1>
            <p>SMA IT Abu Bakar Boarding School</p>
        </header>

        <main>
            <div class="container">
                <!-- Authentication Section -->
                <div id="authSection" class="auth-section">
                    <div class="auth-container">
                        <h2>Login Required</h2>
                        <p>Please sign in with your Google account to vote</p>
                        <button id="googleSignInBtn" class="google-signin-btn">
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                            Sign in with Google
                        </button>
                    </div>
                </div>

                <!-- Voting Section (hidden until authenticated) -->
                <div id="votingSection" class="voting-section-hidden">
                    <h2>PEMILIHAN KETUA PMR 2025/2026</h2>
                    <p class="firebase-status">VOTING KETUA PMR</p>

                    <div class="user-info" id="userInfo">
                        <!-- User info will be displayed here -->
                    </div>

                    <div class="candidates-grid" id="candidatesContainer">
                        <!-- Candidates will be loaded from Firebase -->
                    </div>

                    <div class="voting-controls">
                        <button id="voteBtn" class="vote-button">Pilih</button>
                        <button id="signOutBtn" class="signout-button">Keluar</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2017 SMA IT Abu Bakar Boarding School</p>
        </footer>
    </div>
</body>
</html>
