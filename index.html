<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMR - Pemilihan Ketua 2025/2026</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    <link rel="stylesheet" href="style.css">
    <!-- Medical Icons Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQtlCxwhIXyKxuW5FRyRqOElCz-2_EPjs",
            authDomain: "redcross-76c90.firebaseapp.com",
            projectId: "redcross-76c90",
            storageBucket: "redcross-76c90.firebasestorage.app",
            messagingSenderId: "720435310423",
            appId: "1:720435310423:web:058f8f14743135da62d812",
            measurementId: "G-1N1LDV3R95"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // PMR Voting System JavaScript with Firebase Authentication and Vote Tracking
        document.addEventListener('DOMContentLoaded', function() {
            const candidatesContainer = document.getElementById('candidatesContainer');
            const voteBtn = document.getElementById('voteBtn');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            const authSection = document.getElementById('authSection');
            const votingSection = document.getElementById('votingSection');
            const userInfo = document.getElementById('userInfo');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            // Sample candidate data with medical theme
            const candidates = [
                {
                    id: 'rangga',
                    name: 'Muhammad Rangga',
                    position: 'Calon Ketua PMR',
                    vision: 'Membangun PMR yang lebih aktif dalam pelayanan kesehatan masyarakat dan mengembangkan program-program inovatif untuk meningkatkan kesadaran kesehatan di lingkungan sekolah.',
                    mission: [
                        'Meningkatkan kemampuan P3K anggota PMR',
                        'Mengadakan penyuluhan kesehatan rutin',
                        'Memperbaiki fasilitas UKS sekolah',
                        'Menjalin kerjasama dengan Puskesmas setempat'
                    ],
                    image: 'https://via.placeholder.com/300x200/dc2626/ffffff?text=RANGGA+PMR',
                    color: '#dc2626'
                },
                {
                    id: 'ghazi',
                    name: 'Ghazi',
                    position: 'Calon Ketua PMR',
                    vision: 'Menjadikan PMR sebagai organisasi yang layak,terstruktur, dan menjadi teladan dalam bidang kesehatan.',
                    mission: [
                        'Membuat prosedur yang jelas untuk siswa yang sakit',
                        'Memperbaiki komunikasi diantara para anggota agar dapat bekerja dengan',
                        'Memperlayak fasilitas UKS',
                        'Menjadikan anggota PMR paham tentang kesehatan',
                        'Membawa pengaruh baik tentang kesehatan untuk seluruh warga sekolah'
                    ],
                    image: 'https://via.placeholder.com/300x200/b91c1c/ffffff?text=GHAZI+PMR',
                    color: '#b91c1c'
                }
            ];

            let selectedCandidate = null;
            let currentUser = null;
            let hasVoted = false;
            let votingStep = 0; // 0: auth, 1: select candidate, 2: confirm, 3: voted

            // Update progress
            function updateProgress(step) {
                votingStep = step;
                const steps = ['Masuk', 'Pilih Kandidat', 'Konfirmasi', 'Selesai'];
                const percentage = (step / (steps.length - 1)) * 100;
                
                progressBar.style.width = percentage + '%';
                progressText.textContent = steps[step] || 'Selesai';
                
                // Add animation
                progressBar.style.transition = 'width 0.5s ease-in-out';
            }

            // Load candidates with medical theme
            function loadCandidates() {
                candidatesContainer.innerHTML = '';

                candidates.forEach((candidate, index) => {
                    const candidateCard = document.createElement('div');
                    candidateCard.className = 'candidate-card';
                    candidateCard.dataset.id = candidate.id;
                    candidateCard.style.animationDelay = `${index * 0.2}s`;

                    const missionList = candidate.mission.map(mission => 
                        `<li><i class="fas fa-check-circle"></i> ${mission}</li>`
                    ).join('');

                    candidateCard.innerHTML = `
                        <div class="candidate-badge">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="candidate-image-container">
                            <img src="${candidate.image}" alt="${candidate.name}" class="candidate-image">
                            <div class="candidate-overlay">
                                <i class="fas fa-heart-pulse"></i>
                            </div>
                        </div>
                        <div class="candidate-content">
                            <div class="candidate-name">${candidate.name}</div>
                            <div class="candidate-position">
                                <i class="fas fa-stethoscope"></i>
                                ${candidate.position}
                            </div>
                            <div class="candidate-vision">
                                <h4><i class="fas fa-eye"></i> Visi:</h4>
                                <p>${candidate.vision}</p>
                            </div>
                            <div class="candidate-mission">
                                <h4><i class="fas fa-list-check"></i> Misi:</h4>
                                <ul>${missionList}</ul>
                            </div>
                        </div>
                        <div class="candidate-select-btn">
                            <i class="fas fa-vote-yea"></i>
                            Pilih Kandidat
                        </div>
                    `;

                    candidateCard.addEventListener('click', () => selectCandidate(candidate.id));
                    candidatesContainer.appendChild(candidateCard);
                });
            }

            // Select candidate with animation
            function selectCandidate(candidateId) {
                if (hasVoted) {
                    showNotification('Anda sudah memberikan suara!', 'warning');
                    return;
                }

                // Remove previous selection
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.classList.remove('selected', 'pulse');
                });

                // Add selection to clicked card
                const selectedCard = document.querySelector(`[data-id="${candidateId}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected', 'pulse');
                    selectedCandidate = candidateId;
                    voteBtn.disabled = false;
                    voteBtn.classList.add('enabled');
                    
                    // Update button text
                    const candidate = candidates.find(c => c.id === candidateId);
                    voteBtn.innerHTML = `<i class="fas fa-vote-yea"></i> Pilih ${candidate.name}`;
                    
                    // Scroll to vote button on mobile
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            voteBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                    
                    updateProgress(2);
                    showNotification(`Kandidat ${candidate.name} dipilih!`, 'success');
                }
            }

            // Show notification
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    ${message}
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // Check if user has already voted
            async function checkUserVoteStatus(userId) {
                try {
                    const voteDoc = await getDoc(doc(db, 'votes', userId));
                    if (voteDoc.exists()) {
                        hasVoted = true;
                        const voteData = voteDoc.data();
                        showAlreadyVoted(voteData);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking vote status:', error);
                    return false;
                }
            }

            // Show already voted message
            function showAlreadyVoted(voteData) {
                authSection.style.display = 'none';
                votingSection.style.display = 'block';
                updateProgress(3);

                const candidate = candidates.find(c => c.id === voteData.candidateId);
                userInfo.innerHTML = `
                    <div class="user-profile voted">
                        <div class="user-avatar-container">
                            <img src="${currentUser.photoURL || 'https://via.placeholder.com/60x60/dc2626/ffffff?text=' + currentUser.displayName.charAt(0)}" alt="Profile" class="user-avatar">
                            <div class="user-status-badge">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="user-details">
                            <div class="user-name">${currentUser.displayName}</div>
                            <div class="user-email">${currentUser.email}</div>
                            <div class="user-role">
                                <i class="fas fa-user-graduate"></i>
                                Siswa SMA IT Abu Bakar
                            </div>
                        </div>
                    </div>
                    <div class="vote-status-card">
                        <div class="vote-status-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>Suara Berhasil Tersimpan!</h3>
                        <div class="voted-candidate">
                            <img src="${candidate.image}" alt="${candidate.name}" class="voted-candidate-image">
                            <div class="voted-candidate-info">
                                <div class="voted-candidate-name">${candidate.name}</div>
                                <div class="voted-candidate-position">${candidate.position}</div>
                            </div>
                        </div>
                        <div class="vote-timestamp">
                            <i class="fas fa-clock"></i>
                            Dipilih pada: ${new Date(voteData.timestamp.toDate()).toLocaleString('id-ID')}
                        </div>
                    </div>
                `;

                // Disable voting interface
                voteBtn.style.display = 'none';
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.classList.add('disabled');
                    card.style.pointerEvents = 'none';
                });
            }

            // Handle voting with enhanced UX
            async function handleVote() {
                if (!selectedCandidate) {
                    showNotification('Silakan pilih kandidat terlebih dahulu!', 'warning');
                    return;
                }

                if (hasVoted) {
                    showNotification('Anda sudah memberikan suara!', 'warning');
                    return;
                }

                const candidate = candidates.find(c => c.id === selectedCandidate);
                
                // Show confirmation modal
                const confirmModal = document.createElement('div');
                confirmModal.className = 'modal-overlay';
                confirmModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <i class="fas fa-vote-yea"></i>
                            <h3>Konfirmasi Pilihan</h3>
                        </div>
                        <div class="modal-body">
                            <p>Apakah Anda yakin memilih:</p>
                            <div class="confirm-candidate">
                                <img src="${candidate.image}" alt="${candidate.name}">
                                <div>
                                    <div class="confirm-name">${candidate.name}</div>
                                    <div class="confirm-position">${candidate.position}</div>
                                </div>
                            </div>
                            <div class="warning-text">
                                <i class="fas fa-exclamation-triangle"></i>
                                Pilihan tidak dapat diubah setelah dikonfirmasi
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-cancel" onclick="document.body.removeChild(this.closest('.modal-overlay'))">
                                <i class="fas fa-times"></i> Batal
                            </button>
                            <button class="btn-confirm" onclick="confirmVote()">
                                <i class="fas fa-check"></i> Ya, Pilih!
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(confirmModal);
                setTimeout(() => confirmModal.classList.add('show'), 100);

                // Make confirmVote available globally
                window.confirmVote = async function() {
                    document.body.removeChild(confirmModal);
                    
                    try {
                        // Show loading state
                        voteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                        voteBtn.disabled = true;
                        voteBtn.classList.add('loading');

                        // Record vote in Firestore
                        await setDoc(doc(db, 'votes', currentUser.uid), {
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            userName: currentUser.displayName,
                            candidateId: selectedCandidate,
                            candidateName: candidate.name,
                            timestamp: new Date(),
                            userAgent: navigator.userAgent,
                            ipAddress: 'hidden' // For privacy
                        });

                        // Update local state
                        hasVoted = true;
                        updateProgress(3);

                        // Show success animation
                        setTimeout(() => {
                            voteBtn.innerHTML = '<i class="fas fa-check-circle"></i> Berhasil Dipilih!';
                            voteBtn.classList.remove('loading');
                            voteBtn.classList.add('success');
                            
                            showNotification(`Terima kasih! Suara untuk ${candidate.name} berhasil tersimpan.`, 'success');

                            // Update UI to show voted state
                            setTimeout(() => {
                                showAlreadyVoted({
                                    candidateId: selectedCandidate,
                                    candidateName: candidate.name,
                                    timestamp: { toDate: () => new Date() }
                                });
                            }, 1500);
                        }, 1000);

                    } catch (error) {
                        console.error('Error recording vote:', error);
                        voteBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Coba Lagi';
                        voteBtn.disabled = false;
                        voteBtn.classList.remove('loading');
                        showNotification('Terjadi kesalahan. Silakan coba lagi.', 'warning');
                    }
                };
            }

            // Google Sign In Function
            async function signInWithGoogle() {
                try {
                    googleSignInBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Masuk...';
                    googleSignInBtn.disabled = true;

                    const result = await signInWithPopup(auth, provider);
                    currentUser = result.user;
                    showNotification('Berhasil masuk!', 'success');
                    console.log('User signed in:', currentUser);
                } catch (error) {
                    console.error('Error signing in:', error);
                    showNotification('Gagal masuk: ' + error.message, 'warning');
                } finally {
                    googleSignInBtn.innerHTML = '<i class="fab fa-google"></i> Masuk dengan Google';
                    googleSignInBtn.disabled = false;
                }
            }

            // Sign Out Function
            async function signOutUser() {
                try {
                    await signOut(auth);
                    currentUser = null;
                    selectedCandidate = null;
                    hasVoted = false;
                    votingStep = 0;
                    
                    document.querySelectorAll('.candidate-card').forEach(card => {
                        card.classList.remove('selected', 'disabled', 'pulse');
                        card.style.opacity = '';
                        card.style.pointerEvents = '';
                    });
                    
                    voteBtn.innerHTML = '<i class="fas fa-vote-yea"></i> Pilih Kandidat';
                    voteBtn.disabled = true;
                    voteBtn.classList.remove('enabled', 'success', 'loading');
                    voteBtn.style.display = '';
                    
                    updateProgress(0);
                    showNotification('Berhasil keluar', 'success');
                } catch (error) {
                    console.error('Error signing out:', error);
                    showNotification('Gagal keluar: ' + error.message, 'warning');
                }
            }

            // Update UI based on authentication state
            async function updateUI(user) {
                if (user) {
                    // User is signed in
                    authSection.style.display = 'none';
                    votingSection.style.display = 'block';
                    updateProgress(1);

                    // Check if user has already voted
                    const alreadyVoted = await checkUserVoteStatus(user.uid);

                    if (!alreadyVoted) {
                        userInfo.innerHTML = `
                            <div class="user-profile">
                                <div class="user-avatar-container">
                                    <img src="${user.photoURL || 'https://via.placeholder.com/60x60/dc2626/ffffff?text=' + user.displayName.charAt(0)}" alt="Profile" class="user-avatar">
                                    <div class="user-online-badge"></div>
                                </div>
                                <div class="user-details">
                                    <div class="user-name">${user.displayName}</div>
                                    <div class="user-email">${user.email}</div>
                                    <div class="user-role">
                                        <i class="fas fa-user-graduate"></i>
                                        Siswa SMA IT Abu Bakar
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // User is signed out
                    authSection.style.display = 'block';
                    votingSection.style.display = 'none';
                    userInfo.innerHTML = '';
                    hasVoted = false;
                    updateProgress(0);
                }
            }

            // Authentication state observer
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateUI(user);
            });

            // Event Listeners
            googleSignInBtn.addEventListener('click', signInWithGoogle);
            signOutBtn.addEventListener('click', signOutUser);
            voteBtn.addEventListener('click', handleVote);

            // Initialize
            loadCandidates();
            updateProgress(0);

            // Add enhanced interactions
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected') && !hasVoted) {
                        this.style.transform = 'translateY(-8px) scale(1.02)';
                    }
                });

                card.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected') && !hasVoted) {
                        this.style.transform = '';
                    }
                });
            });

            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        document.body.removeChild(modal);
                    }
                }
            });

            // Add touch feedback for mobile
            if ('ontouchstart' in window) {
                document.querySelectorAll('.candidate-card').forEach(card => {
                    card.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    });
                    
                    card.addEventListener('touchend', function() {
                        setTimeout(() => {
                            this.classList.remove('touch-active');
                        }, 150);
                    });
                });
            }
        });
    </script>
</head>
<body>
    <div id="app">
        <!-- Medical Header -->
        <header class="medical-header">
            <div class="header-background">
                <div class="medical-cross"></div>
                <div class="medical-pulse"></div>
            </div>
            <div class="header-content">
                <div class="logo-container">
                    <div class="pmr-logo">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="header-text">
                        <h1>
                            <span class="pmr-text">PMR</span>
                            <span class="voting-text">VOTING</span>
                        </h1>
                        <p class="subtitle">
                            <i class="fas fa-hospital"></i>
                            Pemilihan Ketua PMR 2025/2026
                        </p>
                        <p class="school-name">SMA IT Abu Bakar Boarding School</p>
                    </div>
                </div>
                
                <!-- Progress Indicator -->
                <div class="progress-container">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-text" id="progressText">Masuk</div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <!-- Authentication Section -->
                <div id="authSection" class="auth-section">
                    <div class="auth-card">
                        <div class="auth-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h2>Masuk untuk Memberikan Suara</h2>
                        <p class="auth-description">
                            Gunakan akun Google Anda untuk masuk dan berpartisipasi dalam pemilihan ketua PMR
                        </p>
                        <button id="googleSignInBtn" class="google-signin-btn">
                            <i class="fab fa-google"></i>
                            Masuk dengan Google
                        </button>
                        <div class="auth-info">
                            <i class="fas fa-info-circle"></i>
                            Data Anda aman dan hanya digunakan untuk verifikasi voting
                        </div>
                    </div>
                </div>

                <!-- Voting Section -->
                <div id="votingSection" class="voting-section">
                    <!-- User Info -->
                    <div class="user-info-section" id="userInfo">
                        <!-- User info will be displayed here -->
                    </div>

                    <!-- Candidates Grid -->
                    <div class="candidates-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-users"></i>
                                Kandidat Ketua PMR
                            </h2>
                            <p class="section-description">
                                Pilih salah satu kandidat yang menurut Anda paling sesuai untuk memimpin PMR
                            </p>
                        </div>
                        
                        <div class="candidates-grid" id="candidatesContainer">
                            <!-- Candidates will be loaded here -->
                        </div>
                    </div>

                    <!-- Voting Controls -->
                    <div class="voting-controls">
                        <button id="voteBtn" class="vote-button" disabled>
                            <i class="fas fa-vote-yea"></i>
                            Pilih Kandidat
                        </button>
                        <button id="signOutBtn" class="signout-button">
                            <i class="fas fa-sign-out-alt"></i>
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="medical-footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <i class="fas fa-heart-pulse"></i>
                    <span>PMR</span>
                </div>
                <div class="footer-text">
                    <p>&copy; 2025 Palang Merah Remaja</p>
                    <p>SMA IT Abu Bakar Boarding School</p>
                </div>
                <div class="footer-links">
                    <a href="admin.html">
                        <i class="fas fa-chart-bar"></i>
                        Admin
                    </a>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>